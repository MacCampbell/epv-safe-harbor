---
title: "206-volcano-plots"
output: html_document
date: "2023-06-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```


```{r}
library(tidyverse)
library(ggrepel)
library(DESeq2)
library(pheatmap)
library(RColorBrewer)
```

Set up automatic making of DE testing and volcano plots

```{r}
meta<-read_csv("meta/rna-seq-meta.csv")
```

```{r}
dat<-read_csv("data/raw_counts-intronic.csv") %>% select(-Gene.name) %>%
  relocate(ID) %>% dplyr::rename(gene_id=ID)
```

```{r}
locus<-c("AAVS1","Dep.2","Dep.55","Prot.218")
```


```{r}
Tester<-function(locus, meta, dat) {
coldata<-meta %>% filter(Locus==locus) %>% select(Sample, Category, Donor, Locus)
coldata2<-meta %>% filter(Category=="Control") %>% filter(Donor %in% coldata$Donor) %>% select(Sample, Category, Donor, Locus)

m<-bind_rows(coldata,coldata2)
m$Category <- factor(m$Category, levels=c("Control","Experiment"))
m$Donor <- factor(m$Donor)
m<-as.data.frame(m)
rownames(m)<-m$Sample
m<-m %>% select(-Sample)


d<-select(dat, gene_id, rownames(m)) 
d<-as.data.frame(d)
rownames(d)<-d$gene_id
d<-d %>% select(-gene_id)

dds <- DESeqDataSetFromMatrix(countData = d,
                              colData = m,
                              design = ~Donor + Category )

#Drop low counts
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]

#Create other data
vsd <- vst(dds, blind=FALSE)
ntd <- normTransform(dds)


ntddata<-assay(ntd)
vsddata<-assay(vsd)

#PCA for fun 
pcaData <- plotPCA(ntd, intgroup=c("Category", "Donor"), returnData=TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))

ggplot(pcaData, aes(PC1, PC2, fill=Donor, shape=Category)) +
  geom_point(size=3) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
  coord_fixed() +
  theme_bw() +
  theme(panel.grid=element_blank()) +
  scale_fill_viridis_d(option="magma") +
  scale_shape_manual(values=c(21,22,23)) +
  guides(fill = guide_legend(override.aes=list(shape=c(22)))) 

ggsave(paste0("outputs/206/",locus,"-pca.pdf"))

#DE testing

dds <- DESeq(dds)
res <- results(dds)

resOrdered <- res[order(res$pvalue),]
summary(res)

results<-as_tibble(resOrdered)
results$Gene<-rownames(resOrdered)
results<-results %>% relocate(Gene) %>% filter(padj<0.05, abs(log2FoldChange) >= 1) %>% mutate(Locus=paste0(locus))

write_csv(results, paste0("outputs/206/",locus,"-results.csv"))

ggplot() +
  geom_point(data=results %>% filter(padj < 0.01), aes(x=log2FoldChange, y=-log10(padj)),
             color="red", alpha=0.9) +
  geom_point(data=results %>% filter(padj >= 0.01), aes(x=log2FoldChange, y=-log10(padj)),
             color="black", alpha=0.9) +
  xlab("log2 (Fold Change)") +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  ggtitle(paste0(locus, "\n")) +
  theme(plot.title = element_text(hjust=0.5, size=16, face="bold")) +
  theme(axis.title = element_text(face="bold")) +
  xlim(-10,10) +
  ylim(0,70)

ggsave(paste0("outputs/206/",locus,"-volcano.jpeg"), width=5, height=4)
  
}

```

```{r}
lapply(locus, Tester, meta, dat)

```

## Summarize 

```{r}
resfiles<-list.files(path="outputs/206/", pattern="*results.csv", full.names = TRUE)

resf<-lapply(resfiles,read_csv) %>% bind_rows()
```

```{r}
resf %>% mutate(Direction=ifelse(log2FoldChange < 0, "Negative", "Positive") %>% group_by(Locus, Direction) %>%
                  summarize(Count=n())
```